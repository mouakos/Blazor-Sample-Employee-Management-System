@page "/"
@using SampleEmployeeManagementSystem.Components.Pages.Employees
@using SampleEmployeeManagementSystem.DataAccess.Services
@using SampleEmployeeManagementSystem.ViewModels
@rendermode InteractiveServer
@inject EmployeeService EmployeeService
@inject IDialogService DialogService

<PageTitle>Home</PageTitle>

<h2 class="text-center">
    Employee Management System
</h2>

<MudDataGrid @ref="m_DataGrid" T="EmployeeViewModel" ServerData="ServerReload" Filterable="false">
    <ToolBarContent>
        <MudButton Class="me-2" 
                   @onclick="CreateNewUser" 
                   StartIcon="@Icons.Material.Filled.PersonAddAlt1" 
                   Variant="Variant.Filled" 
                   Color="Color.Primary">Add New Employee</MudButton>
       
        <MudSpacer/>
        <MudTextField T="string" ValueChanged="@(s => OnSearch(s))" Placeholder="Search" Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0">
        </MudTextField>
    </ToolBarContent>
    <Columns>
        <PropertyColumn Property="x => x.EmployeeIdView" Title="Employee Id"/>
        <PropertyColumn Property="x => x.FullName" Title="Full Name"/>
        <PropertyColumn Property="x => x.Departement" Title="Departement"/>
        <PropertyColumn Property="x => x.DateOfBirth" Title="DateOfBirth" Format="dd MM yyyy"/>
        <PropertyColumn Property="x => x.Age"/>
        <PropertyColumn Property="x => x.PhoneNumber"/>
    </Columns>
    <PagerContent>
        <MudDataGridPager T="EmployeeViewModel"/>
    </PagerContent>
</MudDataGrid>

@code {
    MudDataGrid<EmployeeViewModel>? m_DataGrid;
    private string? m_SearchString;

    /// <summary>
    ///     Here we simulate getting the paged, filtered and ordered data from the server
    /// </summary>
    private async Task<GridData<EmployeeViewModel>> ServerReload(GridState<EmployeeViewModel> state)
    {
        IEnumerable<EmployeeViewModel> data = await EmployeeService.GetAllEmployeesAsync();
        await Task.Delay(300);
        data = data.Where(element =>
        {
            if (string.IsNullOrWhiteSpace(m_SearchString))
                return true;
            return element.FullName != null && (element.EmployeeIdView.Contains(m_SearchString, StringComparison.OrdinalIgnoreCase) || element.FullName.Contains(m_SearchString, StringComparison.OrdinalIgnoreCase));
        }).ToArray();
        var totalItems = data.Count();

        var sortDefinition = state.SortDefinitions.FirstOrDefault();
        if (sortDefinition != null)
        {
            data = sortDefinition.SortBy switch
            {
                nameof(EmployeeViewModel.EmployeeIdView) => data.OrderByDirection(sortDefinition.Descending ? SortDirection.Descending : SortDirection.Ascending, o => o.EmployeeIdView),
                nameof(EmployeeViewModel.FullName) => data.OrderByDirection(sortDefinition.Descending ? SortDirection.Descending : SortDirection.Ascending, o => o.FullName),
                nameof(EmployeeViewModel.Departement) => data.OrderByDirection(sortDefinition.Descending ? SortDirection.Descending : SortDirection.Ascending, o => o.Departement),
                nameof(EmployeeViewModel.Age) => data.OrderByDirection(sortDefinition.Descending ? SortDirection.Descending : SortDirection.Ascending, o => o.Age),
                nameof(EmployeeViewModel.DateOfBirth) => data.OrderByDirection(sortDefinition.Descending ? SortDirection.Descending : SortDirection.Ascending, o => o.DateOfBirth),
                nameof(EmployeeViewModel.PhoneNumber) => data.OrderByDirection(sortDefinition.Descending ? SortDirection.Descending : SortDirection.Ascending, o => o.PhoneNumber),
                _ => data
            };
        }

        var pagedData = data.Skip(state.Page * state.PageSize).Take(state.PageSize).ToArray();
        return new GridData<EmployeeViewModel>
        {
            TotalItems = totalItems,
            Items = pagedData
        };
    }

    private Task OnSearch(string text)
    {
        m_SearchString = text;
        return m_DataGrid?.ReloadServerData()!;
    }

    private async Task CreateNewUser()
    {
        var options = new DialogOptions() { MaxWidth = MaxWidth.Large };
        var dialog = await DialogService.ShowAsync<CreateOrUpdateEmployee>("Create Employee", options);
        var result = await dialog.Result;
        if (result is not { Canceled: true })
            await m_DataGrid?.ReloadServerData()!;
    }

}